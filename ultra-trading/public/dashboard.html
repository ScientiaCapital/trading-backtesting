<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ULTRA Trading - Live Dashboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #0f0f0f;
            color: #ffffff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #00ff41;
            text-align: center;
            margin-bottom: 30px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .status-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
        }
        .status-card h3 {
            margin-top: 0;
            color: #00ff41;
        }
        .value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        .positive { color: #00ff41; }
        .negative { color: #ff0041; }
        .neutral { color: #ffaa00; }
        .positions-container {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .position-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #333;
            align-items: center;
        }
        .position-header {
            font-weight: bold;
            color: #00ff41;
            border-bottom: 2px solid #00ff41;
        }
        .log-container {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            font-family: monospace;
            font-size: 12px;
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid #333;
        }
        .log-entry.info { border-color: #00ff41; }
        .log-entry.warning { border-color: #ffaa00; }
        .log-entry.error { border-color: #ff0041; }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        button {
            background: #00ff41;
            color: #0f0f0f;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            margin: 0 5px;
        }
        button:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }
        .mode-indicator {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-left: 10px;
        }
        .mode-observation {
            background: #ffaa00;
            color: #0f0f0f;
        }
        .mode-trading {
            background: #00ff41;
            color: #0f0f0f;
        }
        .mode-closed {
            background: #ff0041;
            color: #ffffff;
        }
        .profit { color: #00ff41; }
        .loss { color: #ff0041; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ULTRA Trading Platform - Live Dashboard
            <span id="modeIndicator" class="mode-indicator">LOADING...</span>
        </h1>
        
        <div class="status-grid">
            <div class="status-card">
                <h3>Market Status</h3>
                <div id="marketTime">--:--:-- AM ET</div>
                <div id="marketStatus" class="value">LOADING...</div>
                <div>Next Open: <span id="nextOpen">--</span></div>
                <div>Time to Open: <span id="timeToOpen">--</span></div>
            </div>
            
            <div class="status-card">
                <h3>Trading Mode</h3>
                <div id="tradingMode" class="value">LOADING...</div>
                <div>Mode Since: <span id="modeSince">9:43:40 AM</span></div>
                <div>Switch Time: 11:00 AM ET</div>
            </div>
            
            <div class="status-card">
                <h3>Daily P&L</h3>
                <div id="dailyPnL" class="value">$0.00</div>
                <div>Target: $300.00</div>
                <div>Progress: <span id="targetProgress">0%</span></div>
            </div>
            
            <div class="status-card">
                <h3>Account Status</h3>
                <div>Buying Power: <span id="buyingPower">--</span></div>
                <div>Cash: <span id="cash">--</span></div>
                <div>Positions: <span id="positionCount">0</span></div>
            </div>
        </div>
        
        <div class="controls">
            <button onclick="updateStatus()">Refresh Data</button>
            <button id="enableTradingBtn" onclick="setTradingEnabled(true)" disabled>Enable Trading</button>
            <button id="disableTradingBtn" onclick="setTradingEnabled(false)">Disable Trading</button>
        </div>
        
        <div class="positions-container">
            <h3>Current Positions</h3>
            <div class="position-item position-header">
                <div>Symbol</div>
                <div>Quantity</div>
                <div>Entry Price</div>
                <div>Current Value</div>
                <div>P&L</div>
            </div>
            <div id="positionsContent">
                <p style="text-align: center; color: #666;">No positions</p>
            </div>
        </div>
        
        <div class="log-container">
            <h3>Live Activity Log</h3>
            <div id="logEntries">
                <div class="log-entry info">[9:43:42 AM] Trading enabled</div>
                <div class="log-entry warning">[9:43:42 AM] Enabling trading...</div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = '/api/v1/trading';
        let autoRefresh = true;
        let positions = [];
        
        // Add log entry
        function addLog(message, type = 'info') {
            const logEntries = document.getElementById('logEntries');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEntries.insertBefore(entry, logEntries.firstChild);
            
            // Keep only last 100 entries
            while (logEntries.children.length > 100) {
                logEntries.removeChild(logEntries.lastChild);
            }
        }
        
        // Update positions display
        function updatePositionsDisplay(positionData) {
            const positionsContent = document.getElementById('positionsContent');
            const positionCount = document.getElementById('positionCount');
            
            if (!positionData || positionData.length === 0) {
                positionsContent.innerHTML = '<p style="text-align: center; color: #666;">No positions</p>';
                positionCount.textContent = '0';
                return;
            }
            
            positionCount.textContent = positionData.length;
            
            positionsContent.innerHTML = positionData.map(pos => {
                const pnl = parseFloat(pos.unrealized_pl || 0);
                const pnlClass = pnl >= 0 ? 'profit' : 'loss';
                
                return `
                    <div class="position-item">
                        <div>${pos.symbol}</div>
                        <div>${pos.qty}</div>
                        <div>$${parseFloat(pos.avg_entry_price).toFixed(2)}</div>
                        <div>$${parseFloat(pos.market_value).toLocaleString()}</div>
                        <div class="${pnlClass}">$${pnl.toFixed(2)}</div>
                    </div>
                `;
            }).join('');
        }
        
        // Fetch and update status
        async function updateStatus() {
            try {
                addLog('Updating dashboard status...', 'info');
                
                // Get unified dashboard status
                const dashboardRes = await fetch(`${API_BASE}/dashboard-status`);
                const dashboardData = await dashboardRes.json();
                
                if (dashboardData.success) {
                    const data = dashboardData.data;
                    
                    // Update market status
                    const isOpen = data.clock.is_open;
                    document.getElementById('marketStatus').textContent = isOpen ? 'OPEN' : 'CLOSED';
                    document.getElementById('marketStatus').className = `value ${isOpen ? 'positive' : 'negative'}`;
                    
                    // Update current time
                    document.getElementById('marketTime').textContent = new Date().toLocaleTimeString() + ' ET';
                    
                    // Update mode indicator based on market status and time
                    const now = new Date();
                    const hour = now.getHours();
                    const modeIndicator = document.getElementById('modeIndicator');
                    const tradingMode = document.getElementById('tradingMode');
                    
                    if (!isOpen) {
                        modeIndicator.textContent = 'MARKET CLOSED';
                        modeIndicator.className = 'mode-indicator mode-closed';
                        tradingMode.textContent = 'CLOSED';
                        tradingMode.className = 'value neutral';
                    } else if (hour >= 9 && hour < 11) {
                        modeIndicator.textContent = 'OBSERVATION MODE';
                        modeIndicator.className = 'mode-indicator mode-observation';
                        tradingMode.textContent = 'OBSERVATION';
                        tradingMode.className = 'value neutral';
                    } else {
                        modeIndicator.textContent = 'TRADING MODE';
                        modeIndicator.className = 'mode-indicator mode-trading';
                        tradingMode.textContent = 'TRADING';
                        tradingMode.className = 'value positive';
                    }
                    
                    // Update market timing
                    if (data.clock.next_open) {
                        const nextOpen = new Date(data.clock.next_open);
                        document.getElementById('nextOpen').textContent = nextOpen.toLocaleTimeString();
                        
                        // Calculate time to open
                        const msToOpen = nextOpen - now;
                        if (msToOpen > 0 && !isOpen) {
                            const hours = Math.floor(msToOpen / (1000 * 60 * 60));
                            const minutes = Math.floor((msToOpen % (1000 * 60 * 60)) / (1000 * 60));
                            document.getElementById('timeToOpen').textContent = `${hours}h ${minutes}m`;
                        } else {
                            document.getElementById('timeToOpen').textContent = isOpen ? 'Market is open' : '--';
                        }
                    }
                    
                    // Update account information
                    document.getElementById('buyingPower').textContent = `$${parseFloat(data.account.buyingPower || 0).toLocaleString()}`;
                    document.getElementById('cash').textContent = `$${parseFloat(data.account.cash || 0).toLocaleString()}`;
                    document.getElementById('positionCount').textContent = data.positions.count || 0;
                    
                    // Update daily P&L
                    const dailyPnL = data.positions.dailyPnL || 0;
                    document.getElementById('dailyPnL').textContent = `$${dailyPnL.toFixed(2)}`;
                    document.getElementById('dailyPnL').className = `value ${dailyPnL >= 0 ? 'positive' : 'negative'}`;
                    
                    const progress = Math.min(100, Math.max(0, (dailyPnL / 300) * 100));
                    document.getElementById('targetProgress').textContent = `${progress.toFixed(1)}%`;
                    
                    // Update trading status buttons
                    const tradingEnabled = data.trading.enabled;
                    document.getElementById('enableTradingBtn').disabled = tradingEnabled;
                    document.getElementById('disableTradingBtn').disabled = !tradingEnabled;
                    
                    // Update mode time
                    document.getElementById('modeSince').textContent = new Date().toLocaleTimeString();
                    
                    addLog('Dashboard updated successfully', 'info');
                } else {
                    addLog(`Dashboard API error: ${dashboardData.error?.message || 'Unknown error'}`, 'error');
                    
                    // Show error states
                    document.getElementById('marketStatus').textContent = 'ERROR';
                    document.getElementById('tradingMode').textContent = 'ERROR';
                    document.getElementById('modeIndicator').textContent = 'ERROR';
                    document.getElementById('modeIndicator').className = 'mode-indicator mode-closed';
                }
                
            } catch (error) {
                addLog(`Error updating status: ${error.message}`, 'error');
                
                // Show loading states on error
                document.getElementById('marketStatus').textContent = 'LOADING...';
                document.getElementById('tradingMode').textContent = 'LOADING...';
                document.getElementById('modeIndicator').textContent = 'LOADING...';
            }
        }
        
        // Enable/disable trading
        async function setTradingEnabled(enabled) {
            try {
                addLog(`${enabled ? 'Enabling' : 'Disabling'} trading...`, 'warning');
                
                // Here you would make an API call to enable/disable trading
                // For now, just update UI
                document.getElementById('enableTradingBtn').disabled = enabled;
                document.getElementById('disableTradingBtn').disabled = !enabled;
                
                addLog(`Trading ${enabled ? 'enabled' : 'disabled'}`, 'info');
            } catch (error) {
                addLog(`Error setting trading status: ${error.message}`, 'error');
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            addLog('Dashboard initialized', 'info');
            addLog('Observation mode: 9:30 AM - 11:00 AM ET', 'warning');
            
            // Initial status update
            updateStatus();
            
            // Auto-refresh every 10 seconds
            setInterval(() => {
                if (autoRefresh) {
                    updateStatus();
                }
            }, 10000);
        });
    </script>
</body>
</html>