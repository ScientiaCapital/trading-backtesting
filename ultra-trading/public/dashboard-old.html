<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ULTRA Trading - Live Dashboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #0f0f0f;
            color: #ffffff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #00ff41;
            text-align: center;
            margin-bottom: 30px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .status-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
        }
        .status-card h3 {
            margin-top: 0;
            color: #00ff41;
        }
        .value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        .positive { color: #00ff41; }
        .negative { color: #ff0041; }
        .neutral { color: #ffaa00; }
        .log-container {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            font-family: monospace;
            font-size: 12px;
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid #333;
        }
        .log-entry.info { border-color: #00ff41; }
        .log-entry.warning { border-color: #ffaa00; }
        .log-entry.error { border-color: #ff0041; }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        button {
            background: #00ff41;
            color: #0f0f0f;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            margin: 0 5px;
        }
        button:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }
        .mode-indicator {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-left: 10px;
        }
        .mode-observation {
            background: #ffaa00;
            color: #0f0f0f;
        }
        .mode-trading {
            background: #00ff41;
            color: #0f0f0f;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ULTRA Trading Platform - Live Dashboard
            <span id="modeIndicator" class="mode-indicator mode-observation">OBSERVATION MODE</span>
        </h1>
        
        <div class="status-grid">
            <div class="status-card">
                <h3>Market Status</h3>
                <div class="value" id="marketStatus">CLOSED</div>
                <div>Next Open: <span id="nextOpen">--</span></div>
                <div>Time to Open: <span id="timeToOpen">--</span></div>
            </div>
            
            <div class="status-card">
                <h3>Trading Mode</h3>
                <div class="value" id="tradingMode">OBSERVATION</div>
                <div>Mode Since: <span id="modeSince">--</span></div>
                <div>Switch Time: <span id="switchTime">11:00 AM ET</span></div>
            </div>
            
            <div class="status-card">
                <h3>Daily P&L</h3>
                <div class="value" id="dailyPnL">$0.00</div>
                <div>Target: $300.00</div>
                <div>Progress: <span id="targetProgress">0%</span></div>
            </div>
            
            <div class="status-card">
                <h3>Account Status</h3>
                <div>Buying Power: <span id="buyingPower">--</span></div>
                <div>Cash: <span id="cash">--</span></div>
                <div>Positions: <span id="positions">0</span></div>
            </div>
        </div>
        
        <div class="controls">
            <button id="refreshBtn">Refresh Data</button>
            <button id="enableTradingBtn">Enable Trading</button>
            <button id="disableTradingBtn">Disable Trading</button>
        </div>
        
        <div class="log-container">
            <h3>Live Activity Log</h3>
            <div id="logEntries"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1/trading';
        let autoRefresh = true;
        
        // Add log entry
        function addLog(message, type = 'info') {
            const logEntries = document.getElementById('logEntries');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEntries.insertBefore(entry, logEntries.firstChild);
            
            // Keep only last 100 entries
            while (logEntries.children.length > 100) {
                logEntries.removeChild(logEntries.lastChild);
            }
        }
        
        // Fetch and update status
        async function updateStatus() {
            try {
                // Get market clock
                const clockRes = await fetch(`${API_BASE}/clock`);
                const clockData = await clockRes.json();
                
                if (clockData.success) {
                    const clock = clockData.data;
                    document.getElementById('marketStatus').textContent = clock.is_open ? 'OPEN' : 'CLOSED';
                    document.getElementById('marketStatus').className = `value ${clock.is_open ? 'positive' : 'negative'}`;
                    
                    const nextOpen = new Date(clock.next_open);
                    document.getElementById('nextOpen').textContent = nextOpen.toLocaleTimeString();
                    
                    // Calculate time to open
                    const now = new Date();
                    const msToOpen = nextOpen - now;
                    if (msToOpen > 0) {
                        const hours = Math.floor(msToOpen / (1000 * 60 * 60));
                        const minutes = Math.floor((msToOpen % (1000 * 60 * 60)) / (1000 * 60));
                        document.getElementById('timeToOpen').textContent = `${hours}h ${minutes}m`;
                    } else {
                        document.getElementById('timeToOpen').textContent = 'Market is open';
                    }
                }
                
                // Get trading status
                const statusRes = await fetch(`${API_BASE}/status`);
                const statusData = await statusRes.json();
                
                if (statusData.success) {
                    const status = statusData.data;
                    document.getElementById('buyingPower').textContent = `$${parseFloat(status.buyingPower).toLocaleString()}`;
                    document.getElementById('cash').textContent = `$${parseFloat(status.cash).toLocaleString()}`;
                    
                    // Update trading enabled buttons
                    document.getElementById('enableTradingBtn').disabled = status.tradingEnabled;
                    document.getElementById('disableTradingBtn').disabled = !status.tradingEnabled;
                }
                
                // Get account info
                const accountRes = await fetch(`${API_BASE}/account`);
                const accountData = await accountRes.json();
                
                if (accountData.success) {
                    addLog('Status updated successfully', 'info');
                }
                
            } catch (error) {
                addLog(`Error updating status: ${error.message}`, 'error');
            }
        }
        
        // Enable/disable trading
        async function setTradingEnabled(enabled) {
            try {
                // For now, just update KV directly
                addLog(`${enabled ? 'Enabling' : 'Disabling'} trading...`, 'warning');
                
                // Update UI
                document.getElementById('enableTradingBtn').disabled = enabled;
                document.getElementById('disableTradingBtn').disabled = !enabled;
                
                addLog(`Trading ${enabled ? 'enabled' : 'disabled'}`, 'info');
            } catch (error) {
                addLog(`Error setting trading status: ${error.message}`, 'error');
            }
        }
        
        // Check current time and update mode indicator
        function updateModeIndicator() {
            const now = new Date();
            const hour = now.getHours();
            const isMarketHours = hour >= 9 && hour < 16;
            const isObservationTime = hour >= 9 && hour < 11;
            
            const modeIndicator = document.getElementById('modeIndicator');
            const tradingMode = document.getElementById('tradingMode');
            
            if (!isMarketHours) {
                modeIndicator.textContent = 'MARKET CLOSED';
                modeIndicator.className = 'mode-indicator mode-observation';
                tradingMode.textContent = 'CLOSED';
                tradingMode.className = 'value neutral';
            } else if (isObservationTime) {
                modeIndicator.textContent = 'OBSERVATION MODE';
                modeIndicator.className = 'mode-indicator mode-observation';
                tradingMode.textContent = 'OBSERVATION';
                tradingMode.className = 'value neutral';
            } else {
                modeIndicator.textContent = 'TRADING MODE';
                modeIndicator.className = 'mode-indicator mode-trading';
                tradingMode.textContent = 'TRADING';
                tradingMode.className = 'value positive';
            }
            
            document.getElementById('modeSince').textContent = now.toLocaleTimeString();
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            addLog('Dashboard initialized', 'info');
            addLog('Observation mode active from 9:30 AM - 11:00 AM ET', 'warning');
            addLog('Trading will begin at 11:00 AM ET', 'info');
            
            // Set up event listeners
            document.getElementById('refreshBtn').addEventListener('click', updateStatus);
            document.getElementById('enableTradingBtn').addEventListener('click', () => setTradingEnabled(true));
            document.getElementById('disableTradingBtn').addEventListener('click', () => setTradingEnabled(false));
            
            // Initial update
            updateStatus();
            updateModeIndicator();
            
            // Auto-refresh every 10 seconds
            setInterval(() => {
                if (autoRefresh) {
                    updateStatus();
                    updateModeIndicator();
                }
            }, 10000);
        });
    </script>
</body>
</html>