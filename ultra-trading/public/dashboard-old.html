<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ULTRA Trading - Live Dashboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #0f0f0f;
            color: #ffffff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #00ff41;
            text-align: center;
            margin-bottom: 30px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .status-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
        }
        .status-card h3 {
            margin-top: 0;
            color: #00ff41;
        }
        .value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        .positive { color: #00ff41; }
        .negative { color: #ff0041; }
        .neutral { color: #ffaa00; }
        .positions-container {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .position-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #333;
            align-items: center;
        }
        .position-header {
            font-weight: bold;
            color: #00ff41;
            border-bottom: 2px solid #00ff41;
        }
        .log-container {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            font-family: monospace;
            font-size: 12px;
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid #333;
        }
        .log-entry.info { border-color: #00ff41; }
        .log-entry.warning { border-color: #ffaa00; }
        .log-entry.error { border-color: #ff0041; }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        button {
            background: #00ff41;
            color: #0f0f0f;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            margin: 0 5px;
        }
        button:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }
        .mode-indicator {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-left: 10px;
        }
        .mode-observation {
            background: #ffaa00;
            color: #0f0f0f;
        }
        .mode-trading {
            background: #00ff41;
            color: #0f0f0f;
        }
        .mode-closed {
            background: #ff0041;
            color: #ffffff;
        }
        .profit { color: #00ff41; }
        .loss { color: #ff0041; }
        .market-time {
            font-size: 18px;
            font-weight: bold;
            color: #00ff41;
            margin-bottom: 5px;
        }
        .session-progress {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }
        .session-progress-bar {
            height: 100%;
            background: linear-gradient(to right, #00ff41, #ffaa00);
            transition: width 1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: #0f0f0f;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ULTRA Trading Platform - Live Dashboard
            <span id="modeIndicator" class="mode-indicator mode-closed">LOADING...</span>
        </h1>
        
        <div class="status-grid">
            <div class="status-card">
                <h3>Market Status</h3>
                <div class="market-time" id="marketTime">--:--:-- -- ET</div>
                <div class="value" id="marketStatus">LOADING...</div>
                <div>Next Open: <span id="nextOpen">--</span></div>
                <div>Time to Open: <span id="timeToOpen">--</span></div>
                <div class="session-progress">
                    <div class="session-progress-bar" id="sessionProgress" style="width: 0%">0%</div>
                </div>
            </div>
            
            <div class="status-card">
                <h3>Trading Mode</h3>
                <div class="value" id="tradingMode">LOADING...</div>
                <div>Mode Since: <span id="modeSince">--</span></div>
                <div>Switch Time: <span id="switchTime">11:00 AM ET</span></div>
            </div>
            
            <div class="status-card">
                <h3>Daily P&L</h3>
                <div class="value" id="dailyPnL">$0.00</div>
                <div>Target: $300.00</div>
                <div>Progress: <span id="targetProgress">0%</span></div>
            </div>
            
            <div class="status-card">
                <h3>Account Status</h3>
                <div>Buying Power: <span id="buyingPower">--</span></div>
                <div>Cash: <span id="cash">--</span></div>
                <div>Positions: <span id="positionCount">0</span></div>
            </div>
        </div>
        
        <div class="controls">
            <button id="refreshBtn">Refresh Data</button>
            <button id="enableTradingBtn">Enable Trading</button>
            <button id="disableTradingBtn">Disable Trading</button>
        </div>
        
        <div class="positions-container">
            <h3>Current Positions</h3>
            <div id="positionsList">
                <div class="position-item position-header">
                    <div>Symbol</div>
                    <div>Quantity</div>
                    <div>Entry Price</div>
                    <div>Current Value</div>
                    <div>P&L</div>
                </div>
                <div id="positionsContent">
                    <p style="text-align: center; color: #666;">No positions</p>
                </div>
            </div>
        </div>
        
        <div class="log-container">
            <h3>Live Activity Log</h3>
            <div id="logEntries"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1/trading';
        let autoRefresh = true;
        let positions = [];
        
        // Trading Time Clock
        class TradingTime {
            constructor(date = new Date()) {
                this.date = date;
            }
            
            getMarketTime() {
                // Get current time in ET
                return new Date(this.date.toLocaleString('en-US', { timeZone: 'America/New_York' }));
            }
            
            getMarketTimeString() {
                return this.date.toLocaleString('en-US', {
                    timeZone: 'America/New_York',
                    hour12: true,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
            
            isMarketOpen() {
                const marketTime = this.getMarketTime();
                const day = marketTime.getDay();
                if (day === 0 || day === 6) return false;
                
                const hours = marketTime.getHours();
                const minutes = marketTime.getMinutes();
                const currentMinutes = hours * 60 + minutes;
                
                const openMinutes = 9 * 60 + 30; // 9:30 AM
                const closeMinutes = 16 * 60; // 4:00 PM
                
                return currentMinutes >= openMinutes && currentMinutes < closeMinutes;
            }
            
            getSessionProgress() {
                if (!this.isMarketOpen()) return 0;
                
                const marketTime = this.getMarketTime();
                const hours = marketTime.getHours();
                const minutes = marketTime.getMinutes();
                const currentMinutes = hours * 60 + minutes;
                
                const openMinutes = 9 * 60 + 30;
                const closeMinutes = 16 * 60;
                const totalMinutes = closeMinutes - openMinutes;
                
                const elapsedMinutes = currentMinutes - openMinutes;
                return Math.round((elapsedMinutes / totalMinutes) * 100);
            }
        }
        
        // Update market clock every second
        function updateMarketClock() {
            const tradingTime = new TradingTime();
            const marketTimeEl = document.getElementById('marketTime');
            const sessionProgressEl = document.getElementById('sessionProgress');
            
            if (marketTimeEl) {
                marketTimeEl.textContent = tradingTime.getMarketTimeString() + ' ET';
            }
            
            if (sessionProgressEl) {
                const progress = tradingTime.getSessionProgress();
                sessionProgressEl.style.width = progress + '%';
                sessionProgressEl.textContent = progress + '%';
            }
        }
        
        // Update market time display with API data
        function updateMarketTimeDisplay(marketTimeData) {
            const { status, marketTime, nextEvents } = marketTimeData;
            
            // Update session indicator based on actual status
            const sessionIndicator = document.getElementById('modeIndicator');
            if (sessionIndicator) {
                if (status.isOpen) {
                    const marketHour = new Date().getHours();
                    if (marketHour < 11) {
                        sessionIndicator.textContent = 'OBSERVATION MODE';
                        sessionIndicator.className = 'mode-indicator mode-observation';
                    } else {
                        sessionIndicator.textContent = 'TRADING MODE';
                        sessionIndicator.className = 'mode-indicator mode-trading';
                    }
                } else if (status.isPreMarket) {
                    sessionIndicator.textContent = 'PRE-MARKET';
                    sessionIndicator.className = 'mode-indicator mode-observation';
                } else if (status.isAfterHours) {
                    sessionIndicator.textContent = 'AFTER-HOURS';
                    sessionIndicator.className = 'mode-indicator mode-observation';
                } else {
                    sessionIndicator.textContent = 'MARKET CLOSED';
                    sessionIndicator.className = 'mode-indicator mode-closed';
                }
            }
        }
        
        // Add log entry
        function addLog(message, type = 'info') {
            const logEntries = document.getElementById('logEntries');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEntries.insertBefore(entry, logEntries.firstChild);
            
            // Keep only last 100 entries
            while (logEntries.children.length > 100) {
                logEntries.removeChild(logEntries.lastChild);
            }
        }
        
        // Update positions display
        function updatePositionsDisplay(positionData) {
            const positionsContent = document.getElementById('positionsContent');
            const positionCount = document.getElementById('positionCount');
            
            if (!positionData || positionData.length === 0) {
                positionsContent.innerHTML = '<p style="text-align: center; color: #666;">No positions</p>';
                positionCount.textContent = '0';
                return;
            }
            
            positionCount.textContent = positionData.length;
            
            positionsContent.innerHTML = positionData.map(pos => {
                const pnl = parseFloat(pos.unrealized_pl || 0);
                const pnlClass = pnl >= 0 ? 'profit' : 'loss';
                
                return `
                    <div class="position-item">
                        <div>${pos.symbol}${pos.option_type ? ` ${pos.option_type.toUpperCase()} ${pos.strike}` : ''}</div>
                        <div>${pos.qty}</div>
                        <div>$${parseFloat(pos.avg_entry_price).toFixed(2)}</div>
                        <div>$${parseFloat(pos.market_value).toLocaleString()}</div>
                        <div class="${pnlClass}">$${pnl.toFixed(2)}</div>
                    </div>
                `;
            }).join('');
        }
        
        // Fetch market time status
        async function fetchMarketTimeStatus() {
            try {
                const res = await fetch('/api/v1/market-time/status');
                const data = await res.json();
                if (data.success) {
                    return data.data;
                }
            } catch (error) {
                console.error('Failed to fetch market time:', error);
            }
            return null;
        }
        
        // Fetch and update status
        async function updateStatus() {
            try {
                // Get unified dashboard status
                const dashboardRes = await fetch(`${API_BASE}/dashboard-status`);
                const dashboardData = await dashboardRes.json();
                
                if (clockData.success) {
                    const clock = clockData.data;
                    const isOpen = clock.is_open;
                    
                    document.getElementById('marketStatus').textContent = isOpen ? 'OPEN' : 'CLOSED';
                    document.getElementById('marketStatus').className = `value ${isOpen ? 'positive' : 'negative'}`;
                    
                    // Update mode indicator based on market status and time
                    const now = new Date();
                    const hour = now.getHours();
                    const modeIndicator = document.getElementById('modeIndicator');
                    const tradingMode = document.getElementById('tradingMode');
                    
                    if (!isOpen) {
                        modeIndicator.textContent = 'MARKET CLOSED';
                        modeIndicator.className = 'mode-indicator mode-closed';
                        tradingMode.textContent = 'CLOSED';
                        tradingMode.className = 'value neutral';
                    } else if (hour >= 9 && hour < 11) {
                        modeIndicator.textContent = 'OBSERVATION MODE';
                        modeIndicator.className = 'mode-indicator mode-observation';
                        tradingMode.textContent = 'OBSERVATION';
                        tradingMode.className = 'value neutral';
                    } else {
                        modeIndicator.textContent = 'TRADING MODE';
                        modeIndicator.className = 'mode-indicator mode-trading';
                        tradingMode.textContent = 'TRADING';
                        tradingMode.className = 'value positive';
                    }
                    
                    const nextOpen = new Date(clock.next_open);
                    document.getElementById('nextOpen').textContent = nextOpen.toLocaleTimeString();
                    
                    // Calculate time to open
                    const msToOpen = nextOpen - now;
                    if (msToOpen > 0 && !isOpen) {
                        const hours = Math.floor(msToOpen / (1000 * 60 * 60));
                        const minutes = Math.floor((msToOpen % (1000 * 60 * 60)) / (1000 * 60));
                        document.getElementById('timeToOpen').textContent = `${hours}h ${minutes}m`;
                    } else {
                        document.getElementById('timeToOpen').textContent = isOpen ? 'Market is open' : '--';
                    }
                }
                
                // Get trading status
                const statusRes = await fetch(`${API_BASE}/status`);
                const statusData = await statusRes.json();
                
                if (statusData.success) {
                    const status = statusData.data;
                    document.getElementById('buyingPower').textContent = `$${parseFloat(status.buyingPower).toLocaleString()}`;
                    document.getElementById('cash').textContent = `$${parseFloat(status.cash).toLocaleString()}`;
                    
                    // Update trading enabled buttons
                    document.getElementById('enableTradingBtn').disabled = status.tradingEnabled;
                    document.getElementById('disableTradingBtn').disabled = !status.tradingEnabled;
                }
                
                // Get positions
                const positionsRes = await fetch(`${API_BASE}/positions`);
                const positionsData = await positionsRes.json();
                
                if (positionsData.success) {
                    positions = positionsData.data;
                    updatePositionsDisplay(positions);
                    
                    // Calculate daily P&L from positions
                    const dailyPnL = positions.reduce((sum, pos) => sum + parseFloat(pos.unrealized_pl || 0), 0);
                    document.getElementById('dailyPnL').textContent = `$${dailyPnL.toFixed(2)}`;
                    document.getElementById('dailyPnL').className = `value ${dailyPnL >= 0 ? 'positive' : 'negative'}`;
                    
                    const progress = Math.min(100, (dailyPnL / 300) * 100);
                    document.getElementById('targetProgress').textContent = `${progress.toFixed(1)}%`;
                }
                
                // Update mode time
                document.getElementById('modeSince').textContent = new Date().toLocaleTimeString();
                
                addLog('Status updated successfully', 'info');
                
            } catch (error) {
                addLog(`Error updating status: ${error.message}`, 'error');
            }
        }
        
        // Enable/disable trading
        async function setTradingEnabled(enabled) {
            try {
                addLog(`${enabled ? 'Enabling' : 'Disabling'} trading...`, 'warning');
                
                // Here you would make an API call to enable/disable trading
                // For now, just update UI
                document.getElementById('enableTradingBtn').disabled = enabled;
                document.getElementById('disableTradingBtn').disabled = !enabled;
                
                addLog(`Trading ${enabled ? 'enabled' : 'disabled'}`, 'info');
            } catch (error) {
                addLog(`Error setting trading status: ${error.message}`, 'error');
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            addLog('Dashboard initialized', 'info');
            addLog('Observation mode: 9:30 AM - 11:00 AM ET', 'warning');
            addLog('Trading mode: 11:00 AM - 4:00 PM ET', 'info');
            
            // Set up event listeners
            document.getElementById('refreshBtn').addEventListener('click', updateStatus);
            document.getElementById('enableTradingBtn').addEventListener('click', () => setTradingEnabled(true));
            document.getElementById('disableTradingBtn').addEventListener('click', () => setTradingEnabled(false));
            
            // Start market clock
            updateMarketClock();
            setInterval(updateMarketClock, 1000); // Update every second
            
            // Initial update
            updateStatus();
            
            // Auto-refresh every 10 seconds
            setInterval(() => {
                if (autoRefresh) {
                    updateStatus();
                }
            }, 10000);
        });
    </script>
</body>
</html>